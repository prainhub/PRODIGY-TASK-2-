<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee CRUD System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100;
        }
        .container {
            @apply max-w-5xl mx-auto p-4 md:p-8;
        }
        .card {
            @apply bg-white p-6 rounded-lg shadow-md;
        }
        .form-input {
            @apply w-full px-4 py-2 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        .btn {
            @apply font-semibold py-2 px-4 rounded-md transition duration-300;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        .btn-delete {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-edit {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        .message-box {
            @apply p-3 mt-4 text-sm rounded-md;
        }
        .message-success {
            @apply bg-green-100 text-green-700;
        }
        .message-error {
            @apply bg-red-100 text-red-700;
        }
        .hidden {
            display: none;
        }
        table {
            @apply w-full text-left table-auto;
        }
        th, td {
            @apply px-4 py-2 border-b border-gray-200;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <header class="text-center my-8">
            <h1 class="text-4xl font-bold text-gray-800">User Authentication & Employee Management</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Authentication Section -->
            <div id="auth-section" class="card">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Login</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="loginUsername" class="block text-gray-600">Username</label>
                        <input type="text" id="loginUsername" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="loginPassword" class="block text-gray-600">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <div id="authMessage" class="message-box message-error hidden"></div>
                <p class="text-center text-sm text-gray-500 mt-4">
                    Don't have an account? Log in as the default "admin" user (username: admin, password: adminpassword) or go to your server to register a new user.
                </p>
            </div>

            <!-- Employee Management Section (Hidden until authenticated) -->
            <div id="employee-section" class="card hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Employee Management</h2>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700" id="welcomeMessage"></h3>
                    <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                </div>

                <!-- Add/Update Employee Form -->
                <div class="mb-6">
                    <h4 id="formTitle" class="text-lg font-semibold mb-2">Add New Employee</h4>
                    <form id="employeeForm" class="grid grid-cols-1 gap-4 md:grid-cols-3">
                        <input type="hidden" id="employeeId">
                        <input type="text" id="employeeName" placeholder="Name" class="form-input md:col-span-1" required>
                        <input type="text" id="employeePosition" placeholder="Position" class="form-input md:col-span-1" required>
                        <input type="email" id="employeeEmail" placeholder="Email" class="form-input md:col-span-1" required>
                        <button type="submit" id="submitBtn" class="btn btn-primary md:col-span-3">Add Employee</button>
                        <button type="button" id="cancelBtn" class="btn btn-secondary md:col-span-3 hidden">Cancel</button>
                    </form>
                    <div id="crudMessage" class="message-box mt-4 hidden"></div>
                </div>

                <!-- Employee List -->
                <div>
                    <h4 class="text-lg font-semibold mb-2">Employee Records</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6 text-sm font-medium text-gray-600 uppercase tracking-wider">Name</th>
                                    <th class="py-3 px-6 text-sm font-medium text-gray-600 uppercase tracking-wider">Position</th>
                                    <th class="py-3 px-6 text-sm font-medium text-gray-600 uppercase tracking-wider">Email</th>
                                    <th class="py-3 px-6 text-sm font-medium text-gray-600 uppercase tracking-wider text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeeList">
                                <!-- Employee records will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:3000'; // Change this if your server runs on a different port

        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('auth-section');
        const employeeSection = document.getElementById('employee-section');
        const authMessage = document.getElementById('authMessage');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const employeeForm = document.getElementById('employeeForm');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const employeeList = document.getElementById('employeeList');
        const crudMessage = document.getElementById('crudMessage');

        // Initial UI state
        updateUI();

        // Show a message box with a given message and type
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message-box ${type === 'success' ? 'message-success' : 'message-error'}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Update UI based on authentication status
        function updateUI() {
            const token = localStorage.getItem('token');
            if (token) {
                authSection.classList.add('hidden');
                employeeSection.classList.remove('hidden');
                fetchProtectedData();
                fetchEmployees();
            } else {
                authSection.classList.remove('hidden');
                employeeSection.classList.add('hidden');
                showMessage(authMessage, 'You have been logged out.', 'error');
            }
        }

        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginUsername.value;
            const password = loginPassword.value;
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showMessage(authMessage, data.message, 'success');
                    updateUI();
                } else {
                    showMessage(authMessage, data.message, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage(authMessage, 'Login failed. Please try again later.', 'error');
            }
        });

        // Handle logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            updateUI();
        });

        // Fetch protected data to get user info and verify token
        async function fetchProtectedData() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/protected`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (response.ok) {
                    welcomeMessage.textContent = `Welcome, ${data.user.username}! You are a ${data.user.role}.`;
                } else {
                    localStorage.removeItem('token');
                    updateUI();
                }
            } catch (error) {
                console.error('Protected route error:', error);
                localStorage.removeItem('token');
                updateUI();
            }
        }

        // --- Employee CRUD Functions ---

        // Fetch and display all employees
        async function fetchEmployees() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/employees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const employees = await response.json();
                
                if (response.ok) {
                    renderEmployees(employees);
                } else {
                    showMessage(crudMessage, employees.message, 'error');
                }
            } catch (error) {
                console.error('Fetch employees error:', error);
                showMessage(crudMessage, 'Failed to fetch employees.', 'error');
            }
        }

        // Render employees to the table
        function renderEmployees(employees) {
            employeeList.innerHTML = '';
            if (employees.length === 0) {
                employeeList.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No employee records found.</td></tr>';
                return;
            }
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">${employee.name}</td>
                    <td class="px-6 py-4">${employee.position}</td>
                    <td class="px-6 py-4">${employee.email}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="btn btn-edit mr-2" data-id="${employee.id}">Edit</button>
                        <button class="btn btn-delete" data-id="${employee.id}">Delete</button>
                    </td>
                `;
                employeeList.appendChild(row);
            });
        }

        // Handle Add/Update form submission
        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = employeeId.value;
            const name = employeeName.value;
            const position = employeePosition.value;
            const email = employeeEmail.value;
            const token = localStorage.getItem('token');
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/employees/${id}` : `${API_URL}/employees`;

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, position, email })
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage(crudMessage, data.message, 'success');
                    employeeForm.reset();
                    employeeId.value = '';
                    formTitle.textContent = 'Add New Employee';
                    submitBtn.textContent = 'Add Employee';
                    cancelBtn.classList.add('hidden');
                    fetchEmployees();
                } else {
                    showMessage(crudMessage, data.message, 'error');
                }
            } catch (error) {
                console.error('CRUD operation error:', error);
                showMessage(crudMessage, 'An error occurred during the operation.', 'error');
            }
        });

        // Handle Edit/Delete buttons
        employeeList.addEventListener('click', async (e) => {
            const btn = e.target;
            const id = btn.dataset.id;
            const token = localStorage.getItem('token');

            if (btn.classList.contains('btn-delete')) {
                if (confirm('Are you sure you want to delete this employee?')) {
                    try {
                        const response = await fetch(`${API_URL}/employees/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        const data = await response.json();
                        if (response.ok) {
                            showMessage(crudMessage, data.message, 'success');
                            fetchEmployees();
                        } else {
                            showMessage(crudMessage, data.message, 'error');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        showMessage(crudMessage, 'An error occurred while deleting.', 'error');
                    }
                }
            } else if (btn.classList.contains('btn-edit')) {
                const row = btn.closest('tr');
                const name = row.children[0].textContent;
                const position = row.children[1].textContent;
                const email = row.children[2].textContent;

                employeeId.value = id;
                employeeName.value = name;
                employeePosition.value = position;
                employeeEmail.value = email;
                formTitle.textContent = 'Update Employee';
                submitBtn.textContent = 'Update Employee';
                cancelBtn.classList.remove('hidden');
            }
        });
        
        // Handle cancel button for editing
        cancelBtn.addEventListener('click', () => {
            employeeForm.reset();
            employeeId.value = '';
            formTitle.textContent = 'Add New Employee';
            submitBtn.textContent = 'Add Employee';
            cancelBtn.classList.add('hidden');
        });
    </script>
</body>
</html>
